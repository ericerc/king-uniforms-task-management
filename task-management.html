<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>King Uniforms - Task Management</title>
    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    
    <!-- Initialize Firebase -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBDEIvgnnOmz1dkxvMRzaK1JzIf5H_L5JE",
            authDomain: "king-uniforms-drivers.firebaseapp.com",
            projectId: "king-uniforms-drivers",
            storageBucket: "king-uniforms-drivers.firebasestorage.app",
            messagingSenderId: "543363951334",
            appId: "1:543363951334:web:7300f1dc4b2b9a47f12927",
            measurementId: "G-NW0DZ41JXD"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>
    
    <style>
        :root {
            --king-red: #E31837;
            --king-blue: #003B71;
            --king-yellow: #FFB81C;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 1200px;
            margin: 20px auto;
            border-top: 5px solid var(--king-blue);
        }

        .logo-container {
            text-align: center;
            margin-bottom: 1rem;
        }

        .logo-container img {
            max-width: 300px;
            height: auto;
        }

        h1, h2 {
            text-align: center;
            color: var(--king-blue);
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--king-blue);
            font-weight: 600;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--king-blue);
            box-shadow: 0 0 0 3px rgba(0, 59, 113, 0.1);
        }

        button {
            padding: 12px;
            background-color: var(--king-red);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 5px 0;
        }

        button:hover {
            background-color: #c41230;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(227, 24, 55, 0.2);
        }

        .task-form {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .employee-management {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .employee-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .employee-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .employee-item button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
        }

        .employee-item button:hover {
            background-color: #c82333;
        }

        .task-list {
            margin-top: 2rem;
            min-height: 200px;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
            position: relative;
        }

        .save-order-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--king-blue);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            z-index: 10;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .save-order-btn:hover {
            background-color: #002b5a;
            transform: translateY(-1px);
        }

        .save-order-btn.hidden {
            display: none;
        }

        .task-list.drag-over {
            background-color: #e3f2fd;
            border-color: var(--king-blue);
        }

        .task-item {
            background-color: #f9f9f9;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 1rem;
            align-items: center;
            cursor: move;
            transition: all 0.3s ease;
        }

        .task-item.dragging {
            opacity: 0.5;
            background-color: #e9ecef;
        }

        .task-item.drag-over {
            border: 2px dashed var(--king-blue);
            background-color: #e3f2fd;
        }

        .task-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .task-actions {
            display: flex;
            gap: 0.5rem;
        }

        .edit-btn {
            background-color: var(--king-yellow);
            color: var(--king-blue);
        }

        .delete-btn {
            background-color: #dc3545;
        }

        .filters {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
            background-color: #f0f8ff;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #d0e0ff;
        }

        .filters.active {
            display: grid;
        }

        .filter-toggle {
            background-color: var(--king-blue);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 1rem;
            display: inline-block;
        }

        .filter-toggle:hover {
            background-color: #002b5a;
        }

        .filter-toggle::after {
            content: '▼';
            margin-left: 10px;
        }

        .filter-toggle.active::after {
            content: '▲';
        }

        .loading {
            text-align: center;
            margin: 20px 0;
            color: var(--king-blue);
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 59, 113, 0.3);
            border-radius: 50%;
            border-top-color: var(--king-blue);
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .delete-all-btn {
            background-color: #dc3545;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 1rem;
            width: 100%;
        }

        .delete-all-btn:hover {
            background-color: #c82333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo-container">
            <img src="King_Uniforms_LOGO.png" alt="King Uniforms Logo">
        </div>
        <h1>Gestión de Tareas</h1>

        <!-- Employee Management Section -->
        <div class="employee-management">
            <h2>Gestión de Empleados</h2>
            <div class="form-group">
                <input type="text" id="employeeName" placeholder="Ingrese el nombre del empleado" class="form-control">
                <button onclick="addEmployee()" class="btn">Añadir empleados a la lista</button>
            </div>
            <div class="employee-list" id="employeeList">
                <!-- Employee list will be populated here -->
            </div>
        </div>

        <!-- Task Management Section -->
        <div class="task-form">
            <div class="form-group">
                <label for="taskArea">Área</label>
                <select id="taskArea" required>
                    <option value="Mangle 1">Mangle 1</option>
                    <option value="Mangle 2">Mangle 2</option>
                    <option value="Doblado">Doblado</option>
                    <option value="Supervisores">Supervisores</option>
                    <option value="Lavanderos">Lavanderos</option>
                    <option value="Uniformes">Uniformes</option>
                    <option value="Segregado">Segregado</option>
                    <option value="Mantenimiento">Mantenimiento</option>
                </select>
            </div>
            <div class="form-group">
                <label for="taskName">Nombre de la Tarea</label>
                <input type="text" id="taskName" required>
            </div>
            <div class="form-group">
                <label for="taskFrequency">Frecuencia</label>
                <select id="taskFrequency" required>
                    <option value="Diario">Diario</option>
                    <option value="Dos Veces en Semana">Dos Veces en Semana</option>
                    <option value="Semanal">Semanal</option>
                    <option value="Dos Veces al Mes">Dos Veces al Mes</option>
                    <option value="Mensual">Mensual</option>
                    <option value="Cada Dos Meses">Cada Dos Meses</option>
                </select>
            </div>

            <div class="filter-toggle" onclick="toggleFilters()">Filtros</div>
            <div class="filters" id="filters">
                <div class="form-group">
                    <label for="areaFilter">Filtrar por Área</label>
                    <select id="areaFilter" onchange="filterTasks()">
                        <option value="">Todas las Áreas</option>
                        <option value="Mangle 1">Mangle 1</option>
                        <option value="Mangle 2">Mangle 2</option>
                        <option value="Doblado">Doblado</option>
                        <option value="Supervisores">Supervisores</option>
                        <option value="Lavanderos">Lavanderos</option>
                        <option value="Uniformes">Uniformes</option>
                        <option value="Segregado">Segregado</option>
                        <option value="Mantenimiento">Mantenimiento</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="frequencyFilter">Filtrar por Frecuencia</label>
                    <select id="frequencyFilter" onchange="filterTasks()">
                        <option value="">Todas las Frecuencias</option>
                        <option value="Diario">Diario</option>
                        <option value="Dos Veces en Semana">Dos Veces en Semana</option>
                        <option value="Semanal">Semanal</option>
                        <option value="Dos Veces al Mes">Dos Veces al Mes</option>
                        <option value="Mensual">Mensual</option>
                        <option value="Cada Dos Meses">Cada Dos Meses</option>
                    </select>
                </div>
                <button class="delete-all-btn" onclick="deleteAllTasks()">Eliminar Todas las Tareas</button>
            </div>
        </div>

        <button onclick="addTask()">Agregar Tarea</button>

        <div class="task-list" id="taskList" ondragover="allowDrop(event)" ondrop="drop(event)">
            <button id="saveOrderBtn" class="save-order-btn hidden" onclick="saveTaskOrder()">Guardar Orden</button>
            <div class="loading">Cargando tareas...</div>
        </div>
    </div>

    <script>
        let tasks = [];
        let employees = [];
        let editingTaskId = null;
        let draggedTask = null;
        let orderChanged = false;

        // Load employees when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadEmployees();
            loadTasks();
        });

        function loadEmployees() {
            db.collection('employees').get()
                .then(querySnapshot => {
                    employees = [];
                    querySnapshot.forEach(doc => {
                        employees.push({
                            id: doc.id,
                            name: doc.data().name
                        });
                    });
                    displayEmployees();
                });
        }

        function displayEmployees() {
            const employeeList = document.getElementById('employeeList');
            employeeList.innerHTML = '';
            
            employees.forEach(employee => {
                const employeeItem = document.createElement('div');
                employeeItem.className = 'employee-item';
                employeeItem.innerHTML = `
                    <span>${employee.name}</span>
                    <button onclick="deleteEmployee('${employee.id}')">Eliminar</button>
                `;
                employeeList.appendChild(employeeItem);
            });
        }

        function addEmployee() {
            const employeeName = document.getElementById('employeeName').value.trim();
            if (!employeeName) return;

            db.collection('employees').add({
                name: employeeName
            })
            .then(() => {
                document.getElementById('employeeName').value = '';
                loadEmployees();
            });
        }

        function deleteEmployee(employeeId) {
            if (confirm('¿Está seguro que desea eliminar este empleado?')) {
                db.collection('employees').doc(employeeId).delete()
                    .then(() => {
                        loadEmployees();
                    });
            }
        }

        function loadTasks() {
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '<div class="loading">Cargando tareas...</div>';

            db.collection('tasks')
                .get()
                .then((querySnapshot) => {
                    tasks = [];
                    querySnapshot.forEach((doc) => {
                        const taskData = doc.data();
                        console.log('Task data loaded:', taskData);
                        tasks.push({
                            id: doc.id,
                            area: taskData.area || '',
                            name: taskData.name || '',
                            frequency: taskData.frequency || ''
                        });
                    });
                    console.log('Total tasks loaded:', tasks.length);
                    displayTasks(tasks);
                })
                .catch(error => {
                    console.error('Error al cargar tareas:', error);
                    taskList.innerHTML = '<p>Error al cargar las tareas. Por favor intente nuevamente.</p>';
                });
        }

        function displayTasks(tasksToShow) {
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '';

            if (!tasksToShow || tasksToShow.length === 0) {
                taskList.innerHTML = '<p>No hay Tareas al momento</p>';
                return;
            }

            tasksToShow.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = 'task-item';
                taskElement.draggable = true;
                taskElement.id = `task-${task.id}`;
                taskElement.setAttribute('data-task-id', task.id);
                
                // Add drag and drop event listeners
                taskElement.addEventListener('dragstart', dragStart);
                taskElement.addEventListener('dragend', dragEnd);
                taskElement.addEventListener('dragover', dragOver);
                taskElement.addEventListener('drop', drop);

                taskElement.innerHTML = `
                    <div class="task-info">
                        <div><strong>Área:</strong> ${task.area || 'N/A'}</div>
                        <div><strong>Tarea:</strong> ${task.name || 'N/A'}</div>
                        <div><strong>Frecuencia:</strong> ${task.frequency || 'N/A'}</div>
                    </div>
                    <div class="task-actions">
                        <button class="edit-btn" onclick="editTask('${task.id}')">Editar</button>
                        <button class="delete-btn" onclick="deleteTask('${task.id}')">Eliminar</button>
                    </div>
                `;
                taskList.appendChild(taskElement);
            });
        }

        function dragStart(e) {
            draggedTask = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.id);
        }

        function dragEnd(e) {
            this.classList.remove('dragging');
            draggedTask = null;
            // Remove drag-over class from all task items
            document.querySelectorAll('.task-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        function dragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            this.classList.add('drag-over');
        }

        function allowDrop(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function drop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');

            if (draggedTask) {
                const taskList = document.getElementById('taskList');
                const taskElements = Array.from(taskList.getElementsByClassName('task-item'));
                const dropIndex = taskElements.indexOf(this);
                
                if (dropIndex !== -1) {
                    // Remove the dragged task from its current position
                    taskList.removeChild(draggedTask);
                    
                    // Insert it at the new position
                    if (dropIndex === taskElements.length - 1) {
                        taskList.appendChild(draggedTask);
                    } else {
                        taskList.insertBefore(draggedTask, taskElements[dropIndex]);
                    }

                    // Show save button
                    orderChanged = true;
                    document.getElementById('saveOrderBtn').classList.remove('hidden');
                }
            }
        }

        function saveTaskOrder() {
            const taskList = document.getElementById('taskList');
            const taskElements = Array.from(taskList.getElementsByClassName('task-item'));
            const updates = [];

            taskElements.forEach((element, index) => {
                const taskId = element.getAttribute('data-task-id');
                const position = index + 1;
                
                updates.push(
                    db.collection('tasks').doc(taskId).update({
                        position: position
                    })
                );
            });

            Promise.all(updates)
                .then(() => {
                    console.log('Task positions updated successfully');
                    // Hide save button
                    orderChanged = false;
                    document.getElementById('saveOrderBtn').classList.add('hidden');
                    alert('El orden de las tareas ha sido guardado exitosamente');
                })
                .catch(error => {
                    console.error('Error updating task positions:', error);
                    alert('Error al guardar el orden. Por favor intente nuevamente.');
                });
        }

        function filterTasks() {
            const areaFilter = document.getElementById('areaFilter').value;
            const frequencyFilter = document.getElementById('frequencyFilter').value;

            let filteredTasks = tasks;

            if (areaFilter) {
                filteredTasks = filteredTasks.filter(task => task.area === areaFilter);
            }

            if (frequencyFilter) {
                filteredTasks = filteredTasks.filter(task => task.frequency === frequencyFilter);
            }

            displayTasks(filteredTasks);
        }

        function addTask() {
            const area = document.getElementById('taskArea').value;
            const name = document.getElementById('taskName').value;
            const frequency = document.getElementById('taskFrequency').value;

            if (!name || !area || !frequency) {
                alert('Por favor complete todos los campos requeridos');
                return;
            }

            const task = {
                area,
                name,
                frequency,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            console.log('Adding new task:', task);

            db.collection('tasks').add(task)
                .then((docRef) => {
                    console.log('Task added with ID:', docRef.id);
                    // Add the new task to the tasks array
                    tasks.push({
                        id: docRef.id,
                        ...task
                    });
                    // Display the updated tasks list
                    displayTasks(tasks);
                    // Reset the form
                    resetForm();
                })
                .catch(error => {
                    console.error('Error al agregar tarea:', error);
                    alert('Error al agregar tarea. Por favor intente nuevamente.');
                });
        }

        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            editingTaskId = taskId;
            document.getElementById('taskArea').value = task.area;
            document.getElementById('taskName').value = task.name;
            document.getElementById('taskFrequency').value = task.frequency;

            const addButton = document.querySelector('button[onclick="addTask()"]');
            addButton.textContent = 'Actualizar Tarea';
            addButton.onclick = updateTask;
        }

        function updateTask() {
            if (!editingTaskId) return;

            const area = document.getElementById('taskArea').value;
            const name = document.getElementById('taskName').value;
            const frequency = document.getElementById('taskFrequency').value;

            if (!name || !area || !frequency) {
                alert('Por favor complete todos los campos requeridos');
                return;
            }

            const task = {
                area,
                name,
                frequency,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            db.collection('tasks').doc(editingTaskId).update(task)
                .then(() => {
                    loadTasks();
                    resetForm();
                    editingTaskId = null;
                })
                .catch(error => {
                    console.error('Error al actualizar tarea:', error);
                    alert('Error al actualizar tarea. Por favor intente nuevamente.');
                });
        }

        function deleteTask(taskId) {
            if (confirm('¿Está seguro que desea eliminar esta tarea?')) {
                db.collection('tasks').doc(taskId).delete()
                    .then(() => {
                        loadTasks();
                    })
                    .catch(error => {
                        console.error('Error al eliminar tarea:', error);
                        alert('Error al eliminar tarea. Por favor intente nuevamente.');
                    });
            }
        }

        function resetForm() {
            document.getElementById('taskName').value = '';
            document.getElementById('taskArea').value = 'Mangle 1';
            document.getElementById('taskFrequency').value = 'Diario';

            const addButton = document.querySelector('button[onclick="updateTask()"]');
            if (addButton) {
                addButton.textContent = 'Agregar Tarea';
                addButton.onclick = addTask;
            }
        }

        function toggleFilters() {
            const filters = document.getElementById('filters');
            const toggle = document.querySelector('.filter-toggle');
            filters.classList.toggle('active');
            toggle.classList.toggle('active');
        }

        function deleteAllTasks() {
            if (!confirm('¿Está seguro que desea eliminar todas las tareas? Esta acción no se puede deshacer.')) {
                return;
            }

            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '<div class="loading">Eliminando tareas...</div>';

            // Get all tasks from Firestore
            db.collection('tasks').get()
                .then(querySnapshot => {
                    const deletePromises = [];
                    querySnapshot.forEach(doc => {
                        deletePromises.push(doc.ref.delete());
                    });
                    return Promise.all(deletePromises);
                })
                .then(() => {
                    console.log('Todas las tareas eliminadas exitosamente');
                    tasks = [];
                    displayTasks();
                    alert('Todas las tareas han sido eliminadas exitosamente');
                })
                .catch(error => {
                    console.error('Error al eliminar tareas:', error);
                    alert('Error al eliminar las tareas. Por favor intente nuevamente.');
                    displayTasks();
                });
        }
    </script>
</body>
</html> 